---
ID: 2915
post_title: >
  Accessing an Android app secret from
  GitHub Actions using Gradle
author: Jake Lee
post_excerpt: ""
layout: post
permalink: >
  https://blog.jakelee.co.uk/accessing-android-app-secret-from-github-actions-using-gradle/
published: true
post_date: 2020-10-09 16:00:08
---
Often an open source project will have API keys, auth tokens, and other secrets that definitely shouldn't end up in source code. In my <a href="https://github.com/JakeSteam/Apod-Wallpaper-2" target="_blank" rel="noopener noreferrer">current open source project</a> (a rewrite of APOD Wallpaper) I needed to store my APOD API key.

In the past, I've just added it to my <code>local.properties</code> and <a href="https://stackoverflow.com/a/2047477/608312" target="_blank" rel="noopener noreferrer">removed the file from git</a>, but this approach doesn't work when using GitHub Actions!

This post is available <a href="https://gist.github.com/JakeSteam/4ff98553691d1d30949fb1de6adf83a5" target="_blank" rel="noopener noreferrer">as a GitHub gist</a>.

<strong>Note: </strong>As per a couple of comments, you could skip the properties file and use <code>System.getEnv(x)</code>. I personally prefer keeping it in the project's gradle file, to keep the secret only accessible from the project itself.

<!--more-->
<h2>Approach to secrets</h2>
The approach to storing the secret isn't going to change too much, there'll just be a few changes to cater for GitHub Actions (italic = new):
<ol>
 	<li>Store the secret in our local properties</li>
 	<li><em>Store the secret in GitHub's "secret" functionality</em></li>
 	<li><em>In the CI, load this secret into a new <code>local.properties</code> file.</em></li>
 	<li><em>In Gradle, manually load the <code>local.properties</code> file</em></li>
 	<li>Load the secret into the <code>BuildConfig</code>.</li>
 	<li>At runtime, access this new field.</li>
</ol>
<h2>1. Setting up local secret</h2>
All we need to do is open the autogenerated <code>local.properties</code>, and add our secret into it. Make sure to include the speech marks!
<pre>APOD_API_KEY="abcd1234"</pre>
<h2>2. Adding secret to GitHub</h2>
Next, we need to go to the repository's "Settings", then "Secrets", then "New secret". This will let us add a secret with a name &amp; value. Don't include speech marks this time!

<a href="https://blog.jakelee.co.uk/wp-content/uploads/2020/10/zsffTDX.png"><img class="aligncenter wp-image-2917 size-full" src="https://blog.jakelee.co.uk/wp-content/uploads/2020/10/zsffTDX.png" alt="" width="1010" height="592" /></a>
<h2>3. Accessing secret in GitHub Actions</h2>
There's already plenty of great guides to getting GitHub Actions working with Android (<a href="https://proandroiddev.com/how-to-github-actions-building-your-android-app-773779bcacab" target="_blank" rel="noopener noreferrer">simple</a>, <a href="https://www.coletiv.com/blog/android-github-actions-setup/" target="_blank" rel="noopener noreferrer">more complex</a>, <a href="https://medium.com/@wkrzywiec/github-actions-for-android-first-approach-f616c24aa0f9" target="_blank" rel="noopener noreferrer">even more complex</a>). For this project, <a href="https://gist.github.com/JakeSteam/4ff98553691d1d30949fb1de6adf83a5#file-build-yml" target="_blank" rel="noopener noreferrer">here's the full</a> <code>build.yml</code>.

The only addition we need to make is a new job step in <code>build.yml</code> to put the secret into a new <code>local.properties</code> file. This must be done <strong>after</strong> the code is checked out, or the file will be put in the wrong location:
<pre>- name: Access APOD_API_KEY
  env:
    APOD_API_KEY: ${{ secrets.APOD_API_KEY }}
  run: echo APOD_API_KEY=\"$APOD_API_KEY\" &gt; ./local.properties
</pre>
There's 4 steps to this process:
<ol>
 	<li>Access the secret itself (<code>${{ secrets.APOD_API_KEY }}</code>)</li>
 	<li>Use it to set an environment variable (<code>env: APOD_API_KEY</code>)</li>
 	<li>Write the Groovy code ourselves to set a variable we can access in Gradle (<code>run: echo x = \"y\"</code>)</li>
 	<li>Save this code into a new <code>local.properties</code> file: <code>( &gt; ./local.properties)</code></li>
</ol>
<h2>4. Loading the local properties file in Gradle</h2>
In our app-level <code>build.gradle</code>, we need to load our properties file manually, then access the key within. This isn't necessary when running locally, but will be needed for the CI!

We do this by adding a new function, outside of <code>android {}</code> or <code>dependencies {}</code> etc:
<pre>String getApiKey() {
    def propFile = rootProject.file("./local.properties")
    def properties = new Properties()
    properties.load(new FileInputStream(propFile))
    return properties['APOD_API_KEY']
}</pre>
<h2>5. Loading the secret into BuildConfig</h2>
Next, still in the same file, we need to add our secret into the <code>BuildConfig</code>. I'm using the default config, but it's <a href="https://blog.jakelee.co.uk/how-to-define-buildconfig-values-e-g-server-url-using-both-build-flavor-and-build-type/" target="_blank" rel="noopener noreferrer">pretty straightforward</a> to have different values for different flavours / build types:
<pre>android {
    ...
    defaultConfig {
        ...
        buildConfigField ("String", "API_KEY", getApiKey())
    }
}</pre>
<h2>6. Accessing the value at runtime</h2>
Finally, the simplest step of all! Once we've done a build to populate the <code>BuildConfig</code>, we can just access our secret with <code>BuildConfig.API_KEY</code>. Now, when GitHub actions runs our app can access the secret, and the build passes.

<a href="https://blog.jakelee.co.uk/wp-content/uploads/2020/10/0L626L8.png"><img class="aligncenter size-large wp-image-2920" src="https://blog.jakelee.co.uk/wp-content/uploads/2020/10/0L626L8-1024x425.png" alt="" width="700" height="291" /></a>
<h2>Conclusion</h2>
Whilst trying to find a way to store my secret, I was quite surprised there didn't seem to be any complete guides around. The closest I could find was <a href="https://stackoverflow.com/a/62296987/608312" target="_blank" rel="noopener noreferrer">an unvoted StackOverflow post</a> that had most of the information, and still required figuring a few things out!

Currently this post's method only covers the case where there's 1 secret to store. If multiple are needed, a quick solution would be just manually adding more to each step, but I'm sure it's not ideal.

GitHub actions is still (somewhat) new, but so far it definitely seems a strong contender to traditional CIs. The "actions" store seems an excellent way to share functionality between projects, and encourage a strong CI community. Having simple tasks like checking out code and setting up the JAVA JDK as actions makes sure everyone is comfortable with the process, whilst keeping the build config readable.
<h2>Resources</h2>
<ul>
 	<li>Gist for this post: <a href="https://gist.github.com/JakeSteam/4ff98553691d1d30949fb1de6adf83a5" target="_blank" rel="noopener noreferrer">https://gist.github.com/JakeSteam/4ff98553691d1d30949fb1de6adf83a5</a></li>
 	<li>Storing entire gradle properties file as a secret: <a href="https://stackoverflow.com/questions/61988255/how-to-enable-github-actions-access-gradle-properties" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/61988255/how-to-enable-github-actions-access-gradle-properties</a></li>
 	<li>Storing single secret in gradle: <a href="https://stackoverflow.com/questions/62278936/pass-local-properties-in-build-gradle-android-through-git-hub-secret" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/62278936/pass-local-properties-in-build-gradle-android-through-git-hub-secret</a></li>
 	<li>GitHub secrets: <a href="https://docs.github.com/en/free-pro-team@latest/actions/reference/encrypted-secrets" target="_blank" rel="noopener noreferrer">https://docs.github.com/en/free-pro-team@latest/actions/reference/encrypted-secrets</a></li>
 	<li>GitHub actions: <a href="https://github.com/features/actions" target="_blank" rel="noopener noreferrer">https://github.com/features/actions</a></li>
</ul>